# =============================
# STREAMLIT: –ü–û–õ–ù–û–¶–ï–ù–ù–´–ô –ò–ù–¢–ï–†–ê–ö–¢–ò–í–ù–´–ô –¢–ï–†–ú–ò–ù–ê–õ (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π bash-—Å–µ—Å—Å–∏–π)
# =============================
import streamlit as st
import pexpect
import shutil

# –ü—Ä–æ–≤–µ—Ä–∏–º, –µ—Å—Ç—å –ª–∏ bash
BASH_PATH = shutil.which("bash")
if not BASH_PATH:
    st.error("‚ùå bash –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ. –¢–µ—Ä–º–∏–Ω–∞–ª –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.")
else:
    st.success(f"‚úÖ –ù–∞–π–¥–µ–Ω bash: {BASH_PATH}")

@st.cache_resource
def get_bash_session():
    """
    –°–æ–∑–¥–∞—ë—Ç –∏ –∫—ç—à–∏—Ä—É–µ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É—é bash-—Å–µ—Å—Å–∏—é.
    """
    try:
        # –ó–∞–ø—É—Å–∫–∞–µ–º bash –≤ –ø—Å–µ–≤–¥–æ-tty —Ä–µ–∂–∏–º–µ
        child = pexpect.spawn(BASH_PATH, encoding='utf-8', timeout=30)
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –æ–∫–Ω–∞, —á—Ç–æ–±—ã –∫–æ–º–∞–Ω–¥—ã —Ç–∏–ø–∞ `ls --color=auto` —Ä–∞–±–æ—Ç–∞–ª–∏
        child.setwinsize(24, 80)
        # –ñ–¥—ë–º –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
        child.expect(r'\$|# ')  # –∂–¥—ë–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
        return child
    except Exception as e:
        st.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å bash: {e}")
        return None

# –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º —Å–µ—Å—Å–∏—é
bash_session = get_bash_session()

if bash_session is None:
    st.stop()

st.markdown("---")
st.header("üìü –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª (bash —Å–µ—Å—Å–∏—è)")

# –í–≤–æ–¥ –∫–æ–º–∞–Ω–¥—ã
user_input = st.text_input(
    "–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É (–Ω–∞–ø—Ä–∏–º–µ—Ä: `ls -la`, `cd /tmp`, `python3`, `exit` –¥–ª—è –≤—ã—Ö–æ–¥–∞ –∏–∑ —Å–µ—Å—Å–∏–∏)",
    value="",
    key="cmd_input"
)

# –ö–Ω–æ–ø–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
if st.button("‚ñ∂Ô∏è –í—ã–ø–æ–ª–Ω–∏—Ç—å", key="exec_cmd") and user_input.strip():
    try:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –≤ —Å–µ—Å—Å–∏—é
        bash_session.sendline(user_input)

        # –ñ–¥—ë–º –≤—ã–≤–æ–¥–∞ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
        bash_session.expect(r'\$|# ', timeout=30)

        # –ü–æ–ª—É—á–∞–µ–º –≤—Å—ë, —á—Ç–æ –±—ã–ª–æ –≤—ã–≤–µ–¥–µ–Ω–æ (–≤–∫–ª—é—á–∞—è —Å–∞–º—É –∫–æ–º–∞–Ω–¥—É –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç)
        output = bash_session.before.strip()

        # –í—ã–≤–æ–¥–∏–º –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
        st.code(f"$ {user_input}\n{output}", language="bash")

    except pexpect.TIMEOUT:
        st.warning("‚ö†Ô∏è –ö–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ (—Ç–∞–π–º–∞—É—Ç 30 —Å–µ–∫).")
        # –ü–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Ö–æ—Ç—è –±—ã —á–∞—Å—Ç–∏—á–Ω—ã–π –≤—ã–≤–æ–¥
        output = bash_session.before.strip() if bash_session.before else "–ù–µ—Ç –≤—ã–≤–æ–¥–∞"
        st.code(output, language="bash")
    except pexpect.EOF:
        st.error("‚ùå –°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (–≤–æ–∑–º–æ–∂–Ω–æ, –≤—ã –≤–≤–µ–ª–∏ `exit`). –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.")
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—ç—à, —á—Ç–æ–±—ã –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ —Å–æ–∑–¥–∞–ª–∞—Å—å –Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è
        get_bash_session.clear()
        st.stop()
    except Exception as e:
        st.error(f"‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {e}")

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ (–º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —á–µ—Ä–µ–∑ pwd)
if st.button("üìÇ –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é"):
    try:
        bash_session.sendline('pwd')
        bash_session.expect(r'\$|# ')
        pwd_output = bash_session.before.strip()
        st.code(pwd_output, language="bash")
    except:
        st.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å pwd.")

# –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Å—Å–∏–∏
if st.button("üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å bash-—Å–µ—Å—Å–∏—é"):
    get_bash_session.clear()
    st.experimental_rerun()  # –∏–ª–∏ st.rerun() –≤ Streamlit >= 1.27

# –ü–æ–¥—Å–∫–∞–∑–∫–∞
st.info("üí° –°–æ–≤–µ—Ç: –≤–≤–µ–¥–∏—Ç–µ `bash` ‚Äî —á—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤–ª–æ–∂–µ–Ω–Ω—ã–π shell, `exit` ‚Äî —á—Ç–æ–±—ã –≤—ã–π—Ç–∏ –∏–∑ –Ω–µ–≥–æ. "
        "–°–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –º–µ–∂–¥—É –≤—ã–∑–æ–≤–∞–º–∏. –û–ø–∞—Å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã (`rm`, `dd`, `mkfs`) —Ä–∞–±–æ—Ç–∞—é—Ç ‚Äî –±—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã!")